name: CI

on:
  pull_request:
    branches: ["master"]

permissions:
  contents: read

jobs:
  version:
    name: GitVersion
    runs-on: ubuntu-latest
    outputs:
      semVer: ${{ steps.gitversion.outputs.semVer }}
      fullSemVer: ${{ steps.gitversion.outputs.fullSemVer }}
      informationalVersion: ${{ steps.gitversion.outputs.informationalVersion }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install GitVersion
        uses: gittools/actions/gitversion/setup@v0.10.2
        with:
          versionSpec: "6.x"

      - name: Determine Version
        id: gitversion
        uses: gittools/actions/gitversion/execute@v0.10.2
        with:
          useConfigFile: true

      - name: Display GitVersion outputs
        run: |
          echo "SemVer: ${{ steps.gitversion.outputs.semVer }}"
          echo "FullSemVer: ${{ steps.gitversion.outputs.fullSemVer }}"
          echo "InformationalVersion: ${{ steps.gitversion.outputs.informationalVersion }}"

  unit:
    name: Unit tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    needs: version
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12"]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Display GitVersion
        run: |
          echo "SemVer: ${{ needs.version.outputs.semVer }}"
          echo "FullSemVer: ${{ needs.version.outputs.fullSemVer }}"
          echo "InformationalVersion: ${{ needs.version.outputs.informationalVersion }}"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt

      - name: Run tests
        run: |
          python -m pytest -m "not integration"

  integration:
    name: Integration tests (Python 3.12)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: version

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip

      - name: Display GitVersion
        run: |
          echo "SemVer: ${{ needs.version.outputs.semVer }}"
          echo "FullSemVer: ${{ needs.version.outputs.fullSemVer }}"
          echo "InformationalVersion: ${{ needs.version.outputs.informationalVersion }}"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt

      - name: Run integration tests
        run: |
          python -m pytest -m integration
